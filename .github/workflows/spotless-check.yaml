name: Spotless Workflow

on:
  push:
    branches:
      - '*'

jobs:
  workflow-setup:
    name: Workflow Setup
    runs-on: ubuntu-latest

    steps:
      - name: Use Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Set up JDK 16
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '16'

  spotless-check:
    name: Spotless Check
    runs-on: ubuntu-latest
    needs: workflow-setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Run Spotless Check
        run: mvn spotless:check
        continue-on-error: true

  spotless-apply:
    name: Spotless Apply
    runs-on: ubuntu-latest
    needs: spotless-check

    steps:
      - name: Run Spotless Apply
        run: |
          git diff --name-only HEAD^ HEAD > modified_files.txt
          mvn spotless:apply -DspotlessFiles=$(cat modified_files.txt)

      - name: Re-run Spotless if Failed
        if: ${{ failure() }}
        run: |
          git diff --name-only HEAD^ HEAD > modified_files.txt
          mvn spotless:apply -DspotlessFiles=$(cat modified_files.txt)

  merge-verify:
    name: Merge Verify
    runs-on: ubuntu-latest
    needs: spotless-apply

    steps:
      - name: Verify Spotless Apply
        run: |
          echo "::error::Spotless check failed. Changes cannot be merged."
          exit 1

  merge-changes:
    name: Merge Changes
    runs-on: ubuntu-latest
    needs: merge-verify

    steps:
      - name: Merge Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git merge ${{ github.ref }}

  clean-repository:
    name: Clean Repository
    runs-on: ubuntu-latest
    needs: merge-changes

    steps:
      - name: Run Spotless Apply on Entire Repository
        run: mvn spotless:apply
        continue-on-error: true

      - name: Re-run Spotless Apply if Failed
        if: ${{ failure() }}
        run: mvn spotless:apply